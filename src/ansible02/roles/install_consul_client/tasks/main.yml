---
- name: Update apt cache
  raw: apt update
  become: yes

- name: Create consul user
  raw: useradd --system --home /etc/consul.d --shell /bin/false consul || true
  become: yes

- name: Create consul directories
  raw: |
    mkdir -p /opt/consul
    mkdir -p /etc/consul.d
    chown -R consul:consul /opt/consul /etc/consul.d
  become: yes

- name: Copy consul binary
  copy:
    src: consul
    dest: /usr/local/bin/consul
    mode: '0755'
    owner: root
    group: root
  become: yes

- name: Get VM IP address
  raw: hostname -I | awk '{print $2}'
  register: vm_ip
  become: yes

- name: Create consul client configuration with correct IP
  copy:
    content: |
      datacenter = "dc1"
      data_dir = "/opt/consul"
      log_level = "INFO"
      server = false
      bind_addr = "{{ vm_ip.stdout.strip() }}"
      advertise_addr = "{{ vm_ip.stdout.strip() }}"
      retry_join = ["192.168.56.13"]
      connect {
        enabled = true
      }
    dest: /etc/consul.d/consul.hcl
    owner: consul
    group: consul
    mode: '0640'
  become: yes

- name: Create consul systemd service
  copy:
    content: |
      [Unit]
      Description=Consul
      Documentation=https://www.consul.io/
      Requires=network-online.target
      After=network-online.target
      ConditionFileNotEmpty=/etc/consul.d/consul.hcl

      [Service]
      Type=notify
      User=consul
      Group=consul
      ExecStart=/usr/local/bin/consul agent -config-dir=/etc/consul.d/
      ExecReload=/bin/kill -HUP $MAINPID
      KillMode=process
      Restart=on-failure
      LimitNOFILE=65536

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/consul.service
    mode: '0644'
  become: yes

- name: Start and enable consul
  raw: |
    systemctl daemon-reload
    systemctl enable consul
    systemctl start consul
  become: yes
